vmType: vz
arch: aarch64

mountType: virtiofs

mounts:
- location: "/opt/lima/storage"
  mountPoint: "/opt/local-path-provisioner"
  writable: true

rosetta:
  enabled: true
  binfmt: true

images:
- location: "https://cloud-images.ubuntu.com/releases/noble/release-20250805/ubuntu-24.04-server-cloudimg-arm64.img"
  arch: "aarch64"
  digest: "sha256:6177a7958f0168e38ca58c13961bdc613d71b9771148add03bc4ad637eb01b8d"
- location: "https://cloud-images.ubuntu.com/releases/noble/release/ubuntu-24.04-server-cloudimg-arm64.img"
  arch: "aarch64"
- location: "https://cloud-images.ubuntu.com/releases/noble/release-20250805/ubuntu-24.04-server-cloudimg-amd64.img"
  arch: "x86_64"
  digest: "sha256:834af9cd766d1fd86eca156db7dff34c3713fbbc7f5507a3269be2a72d2d1820"
- location: "https://cloud-images.ubuntu.com/releases/noble/release/ubuntu-24.04-server-cloudimg-amd64.img"
  arch: "x86_64"

cpus: 2
memory: "4GiB"
disk: "20GiB"

networks:
- lima: shared
  macAddress: "52:55:55:12:34:02"

portForwards:
- guestPort: 80
  hostIP: "0.0.0.0"
- guestPort: 443
  hostIP: "0.0.0.0"
- guestPortRange: [30000, 32767]
  hostPortRange: [30000, 32767]
  hostIP: "0.0.0.0"
- ignore: true
  proto: any
  guestIP: "0.0.0.0"

containerd:
  system: false
  user: false

hostResolver:
  hosts:
    host.docker.internal: host.lima.internal

provision:
- mode: system
  script: |
    #!/bin/bash

    sed -i 's/host.lima.internal.*/host.lima.internal host.docker.internal/' /etc/hosts

- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail

    command -v docker > /dev/null 2>&1 && exit 0

    curl -fsSL https://get.docker.com | env DEBIAN_FRONTEND=noninteractive sh
    usermod -a -G docker {{.User}}

    mkdir -p /etc/systemd/system/docker.socket.d
    cat <<'EOF' > /etc/systemd/system/docker.socket.d/override.conf
    [Socket]
    SocketUser={{.User}}
    EOF
    systemctl daemon-reload
    systemctl restart docker.socket

    curl -fsSLO https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.20/cri-dockerd-0.3.20.arm64.tgz
    tar -zxf cri-dockerd-0.3.20.arm64.tgz -C /usr/local/bin --strip-components 1 cri-dockerd/cri-dockerd
    chmod +x /usr/local/bin/cri-dockerd
    chown root:root /usr/local/bin/cri-dockerd
    rm -f cri-dockerd-0.3.20.arm64.tgz

    curl -fsSL https://raw.githubusercontent.com/Mirantis/cri-dockerd/refs/tags/v0.3.20/packaging/systemd/cri-docker.service -o /etc/systemd/system/cri-docker.service
    curl -fsSL https://raw.githubusercontent.com/Mirantis/cri-dockerd/refs/tags/v0.3.20/packaging/systemd/cri-docker.socket -o /etc/systemd/system/cri-docker.socket
    sed -i -e 's,/usr/bin/cri-dockerd,/usr/local/bin/cri-dockerd,' /etc/systemd/system/cri-docker.service

    systemctl daemon-reload
    systemctl reenable cri-docker.socket
    systemctl restart cri-docker.socket

- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail

    cat <<EOF | tee -a /etc/hosts > /dev/null
    192.168.105.100 sandbox.kube sandbox
    192.168.105.101 lima-cp-1 cp-1
    192.168.105.102 lima-cp-2 cp-2
    192.168.105.103 lima-cp-3 cp-3
    192.168.105.104 lima-worker-1 worker-1
    192.168.105.105 lima-worker-2 worker-2
    192.168.105.106 lima-worker-3 worker-3
    EOF

    mkdir -p /etc/systemd/resolved.conf.d
    cat <<EOF | tee /etc/systemd/resolved.conf.d/disable-stub.conf > /dev/null
    [Resolve]
    DNSStubListener=no
    EOF
    ln -sfn /run/systemd/resolve/resolv.conf /etc/resolv.conf
    systemctl restart systemd-resolved

- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail

    cat <<EOF | tee -a /etc/modules-load.d/k8s.conf > /dev/null
    overlay
    br_netfilter
    ip_vs
    ip_vs_rr
    ip_vs_wrr
    ip_vs_sh
    EOF

    modprobe overlay
    modprobe br_netfilter
    modprobe ip_vs
    modprobe ip_vs_rr
    modprobe ip_vs_wrr
    modprobe ip_vs_sh

    cat <<EOF | tee -a /etc/sysctl.d/k8s.conf > /dev/null
    net.bridge.bridge-nf-call-iptables  = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    net.ipv4.ip_forward                 = 1
    EOF

    sysctl --system

- mode: system
  script: |
    #!/bin/bash
    set -feux -o pipefail

    export DEBIAN_FRONTEND='noninteractive'
    export NEEDRESTART_MODE='a'

    K8S_REPO='v1.33'
    K8S_VERSION='1.33.5'

    apt-get update -y -q
    apt-get install -y -q apt-transport-https ca-certificates curl gnupg ipvsadm jq acl socat

    # apt-get install -y -q binfmt-support qemu-user-static
    curl -fsSL https://gist.githubusercontent.com/avoidik/5239a54da643a0499f627492285605b8/raw/6a02b448076709e9f7a3b75e4431211252df6e3c/qemu-binfmt-conf.sh -o /usr/local/bin/qemu-binfmt-conf.sh
    chmod +x /usr/local/bin/qemu-binfmt-conf.sh

    mkdir -p /etc/apt/keyrings
    curl -fsSL https://pkgs.k8s.io/core:/stable:/${K8S_REPO}/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/${K8S_REPO}/deb/ /" | tee /etc/apt/sources.list.d/kubernetes.list

    cat <<EOF | tee /etc/crictl.yaml > /dev/null
    runtime-endpoint: unix:///run/cri-dockerd.sock
    EOF
    setfacl --modify user:{{.User}}:rw /run/cri-dockerd.sock

    apt-get update -y -q
    apt-get install -y -q kubernetes-cni cri-tools
    rm -f /etc/cni/net.d/*.conf*

    apt-get install -y -q kubeadm="${K8S_VERSION}-*" kubectl="${K8S_VERSION}-*" kubelet="${K8S_VERSION}-*"
    apt-mark hold kubeadm kubectl kubelet
    systemctl enable --now kubelet

- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail

    curl -fsSLO https://raw.githubusercontent.com/avoidik/k8s-on-macos/refs/heads/main/assets-docker/cp-2.yaml

    mkdir -p /etc/kubernetes/manifests

    KVVERSION='v0.9.2'
    INTERFACE='lima0'
    VIP='192.168.105.100'
    ctr image pull ghcr.io/kube-vip/kube-vip:"$KVVERSION"
    ctr run --rm --net-host ghcr.io/kube-vip/kube-vip:"$KVVERSION" vip /kube-vip manifest pod \
        --arp \
        --controlplane \
        --address "$VIP" \
        --interface "$INTERFACE" \
        --enableLoadBalancer \
        --leaderElection | \
          tee /etc/kubernetes/manifests/kube-vip.yaml > /dev/null

    kubeadm join --config cp-2.yaml

- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail

    KUBECONFIG='/etc/kubernetes/admin.conf'
    mkdir -p {{.Home}}/.kube
    cp -f "$KUBECONFIG" {{.Home}}/.kube/config
    chown -R {{.User}}:{{.User}} {{.Home}}/.kube

- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail

    export KUBECONFIG='/etc/kubernetes/admin.conf'
    kubectl taint nodes cp-2 node.cilium.io/agent-not-ready=true:NoExecute --overwrite

probes:
- description: "docker to be completed"
  script: |
    #!/bin/bash
    set -eux -o pipefail
    if ! timeout 30s bash -c "until command -v docker >/dev/null 2>&1; do sleep 3; done"; then
      echo >&2 "docker is not installed yet"
      exit 1
    fi
  hint: |
    See "/var/log/cloud-init-output.log" in the guest

- description: "kubeadm to be installed"
  script: |
    #!/bin/bash
    set -eux -o pipefail
    if ! timeout 30s bash -c "until command -v kubeadm >/dev/null 2>&1; do sleep 3; done"; then
      echo >&2 "kubeadm is not installed yet"
      exit 1
    fi
  hint: |
    See "/var/log/cloud-init-output.log" in the guest

- description: "kubeadm to be completed"
  script: |
    #!/bin/bash
    set -eux -o pipefail
    if ! timeout 300s bash -c "until test -f /etc/kubernetes/admin.conf; do sleep 3; done"; then
      echo >&2 "k8s is not running yet"
      exit 1
    fi
  hint: |
    The k8s kubeconfig file has not yet been created.

copyToHost:
- guest: "/etc/kubernetes/admin.conf"
  host: "{{.Dir}}/copied-from-guest/cp-2-kubeconfig.yaml"
  deleteOnStop: true

message: |
  To run `kubectl` on the host (assumes kubectl is installed), run the following commands:
  ------
  export KUBECONFIG="{{.Dir}}/copied-from-guest/cp-2-kubeconfig.yaml"
  kubectl ...
  ------
